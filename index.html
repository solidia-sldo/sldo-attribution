<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Test SLDO4</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>

<h1>Test de déclenchement SLDO4</h1>
<button onclick="tester()">Tester l’achat</button>
<p id="status"></p>

<script>
  const sldo4Address = "0xA86aD75aAAD7Cc1Fd9F4fca3484059CB9b8B1978";
  const sldo4Abi = ["function buyWithSLD()"];

  async function switchToBase(provider) {
    const base = {
      chainId: "0x2105",
      chainName: "Base",
      nativeCurrency: { name: "Ethereum", symbol: "ETH", decimals: 18 },
      rpcUrls: ["https://mainnet.base.org"],
      blockExplorerUrls: ["https://basescan.org"]
    };
    try {
      await provider.send("wallet_switchEthereumChain", [{ chainId: base.chainId }]);
    } catch (e) {
      if (e.code === 4902) {
        await provider.send("wallet_addEthereumChain", [base]);
      } else {
        throw new Error("Changement de réseau refusé.");
      }
    }
  }

  async function tester() {
    const status = document.getElementById("status");
    status.innerText = "Connexion…";

    try {
      if (!window.ethereum) {
        status.innerText = "❌ Aucun portefeuille détecté.";
        return;
      }

      const provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      await switchToBase(provider);
      const signer = provider.getSigner();
      const address = await signer.getAddress();
      status.innerText = `✅ Connecté : ${address}\nPréparation de la transaction…`;

      const sldo4 = new ethers.Contract(sldo4Address, sldo4Abi, signer);
      const tx = await sldo4.buyWithSLD();
      await tx.wait();

      status.innerText = "✅ Transaction réussie.";
    } catch (err) {
      console.error(err);
      if (err.code === 'UNPREDICTABLE_GAS_LIMIT') {
        status.innerText = "❌ Transaction refusée par le contrat (palier inactif ou complet).";
      } else {
        status.innerText = "❌ Erreur : " + (err.reason || err.message || "Transaction refusée.");
      }
    }
  }
</script>

</body>
</html>
