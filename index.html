<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Test SLDO2</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>

<h1>Test de déclenchement SLDO2</h1>
<button onclick="tester()">Tester l’achat</button>
<p id="status"></p>

<script>
  const sldo2Address = "0x62701d3516e827f6a1bff888dfc94a2bba50e345";
  const sldo2Abi = ["function buyWithSLD(uint256)"];

  async function switchToBase(provider) {
    const base = {
      chainId: "0x2105",
      chainName: "Base",
      nativeCurrency: { name: "Ethereum", symbol: "ETH", decimals: 18 },
      rpcUrls: ["https://mainnet.base.org"],
      blockExplorerUrls: ["https://basescan.org"]
    };
    try {
      await provider.send("wallet_switchEthereumChain", [{ chainId: base.chainId }]);
    } catch (e) {
      if (e.code === 4902) {
        await provider.send("wallet_addEthereumChain", [base]);
      } else {
        throw new Error("Changement de réseau refusé.");
      }
    }
  }

  async function tester() {
    const status = document.getElementById("status");
    status.innerText = "Connexion…";

    try {
      if (!window.ethereum) {
        status.innerText = "❌ Aucun portefeuille détecté.";
        return;
      }

      const provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      await switchToBase(provider);
      const signer = provider.getSigner();
      const address = await signer.getAddress();
      status.innerText = `✅ Connecté : ${address}\nPréparation de la transaction…`;

      const sldo2 = new ethers.Contract(sldo2Address, sldo2Abi, signer);
      const tx = await sldo2.buyWithSLD(1); // test avec 1 SLDO
      await tx.wait();

      status.innerText = "✅ Transaction réussie.";
    } catch (err) {
      console.error(err);
      status.innerText = "❌ Erreur : " + err.message;
    }
  }
</script>

</body>
</html>
